<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ display }} — Memory Book</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=Fragment+Mono&display=swap');

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --white: #f0ece4;
      --white-dim: rgba(240, 236, 228, 0.45);
      --white-faint: rgba(240, 236, 228, 0.08);
      --white-ghost: rgba(240, 236, 228, 0.03);
      --black: #0a0a09;
      --accent: rgba(147, 130, 220, 0.8);
      --accent-dim: rgba(147, 130, 220, 0.15);
      --green: rgba(105, 219, 124, 0.7);
      --green-dim: rgba(105, 219, 124, 0.1);
    }

    html { background: var(--black); }

    body {
      min-height: 100vh;
      background: var(--black);
      font-family: 'DM Sans', sans-serif;
      color: var(--white);
    }

    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      min-width: 260px;
      min-height: 100vh;
      border-right: 1px solid var(--white-faint);
      padding: 24px 0;
      overflow-y: auto;
    }

    .sidebar-logo {
      font-family: 'Instrument Serif', serif;
      font-size: 32px;
      font-weight: 400;
      padding: 0 20px 20px;
      text-align: center;
      border-bottom: 1px solid var(--white-faint);
      margin-bottom: 16px;
    }

    .sidebar-logo a {
      color: var(--white);
      text-decoration: none;
    }

    .sidebar-logo a span { color: var(--accent); }

    .sidebar-section {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(240, 236, 228, 0.2);
      padding: 12px 20px 6px;
    }

    .sidebar-item {
      display: block;
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.4);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }

    .sidebar-item:hover {
      color: rgba(240, 236, 228, 0.8);
      background: var(--white-ghost);
    }

    .sidebar-item.active {
      color: var(--white);
      border-left-color: var(--accent);
      background: var(--accent-dim);
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 32px clamp(20px, 4vw, 60px) 80px;
    }

    /* Mobile back */
    .mobile-back {
      display: none;
      margin-bottom: 16px;
    }
    .mobile-back a {
      font-family: 'Fragment Mono', monospace;
      font-size: 12px;
      color: var(--white-dim);
      text-decoration: none;
      transition: color 0.2s;
    }
    .mobile-back a:hover { color: var(--white); }

    /* Header */
    .view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      animation: fadeDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .view-header h1 {
      font-family: 'Instrument Serif', serif;
      font-weight: 400;
      font-size: clamp(28px, 4vw, 42px);
      letter-spacing: -0.03em;
    }

    .view-actions {
      display: flex; gap: 10px; align-items: center;
    }

    .view-actions .save-status {
      font-size: 12px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.3);
      transition: all 0.3s;
    }

    .view-actions .save-status.saved { color: var(--green); }

    .btn {
      padding: 8px 18px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: rgba(240, 236, 228, 0.5);
    }

    .btn:hover {
      color: var(--white);
      border-color: rgba(240, 236, 228, 0.15);
      background: rgba(240, 236, 228, 0.06);
    }

    .btn.active {
      background: var(--accent-dim);
      border-color: rgba(147, 130, 220, 0.3);
      color: var(--accent);
    }

    /* Table of contents */
    .toc {
      margin-bottom: 30px;
      padding: 18px 22px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 12px;
      animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.1s;
    }

    .toc-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(240, 236, 228, 0.25);
      margin-bottom: 10px;
    }

    .toc a {
      display: block;
      padding: 4px 0;
      font-size: 13px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.5);
      text-decoration: none;
      transition: color 0.2s;
    }

    .toc a:hover { color: var(--accent); }

    /* Sections (read mode) */
    .sections {
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.15s;
    }

    .section-card {
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 14px;
      padding: 24px 28px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .section-card:hover {
      border-color: rgba(240, 236, 228, 0.1);
    }

    .section-card h2 {
      font-family: 'Instrument Serif', serif;
      font-size: 22px;
      font-weight: 400;
      letter-spacing: -0.02em;
      margin-bottom: 14px;
      color: var(--white);
    }

    .section-card .content {
      font-size: 14px;
      font-weight: 300;
      line-height: 1.75;
      color: rgba(240, 236, 228, 0.65);
    }

    .section-card .content strong {
      color: rgba(240, 236, 228, 0.85);
      font-weight: 500;
    }

    .section-card .content code {
      font-family: 'Fragment Mono', monospace;
      font-size: 12px;
      background: var(--white-faint);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--accent);
    }

    .section-card .content ul, .section-card .content ol {
      padding-left: 20px;
    }

    .section-card .content li {
      margin-bottom: 4px;
    }

    .section-card .content a {
      color: var(--accent);
      text-decoration: none;
    }

    .section-card .content a:hover { text-decoration: underline; }

    /* Editor */
    .editor-wrap {
      display: none;
      animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .editor-wrap.active { display: block; }

    .editor {
      width: 100%;
      min-height: 70vh;
      padding: 24px 28px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 14px;
      color: rgba(240, 236, 228, 0.8);
      font-family: 'Fragment Mono', monospace;
      font-size: 13px;
      line-height: 1.75;
      resize: vertical;
      outline: none;
      transition: border-color 0.3s;
    }

    .editor:focus {
      border-color: rgba(147, 130, 220, 0.3);
    }

    /* Animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(28px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .mobile-back { display: block; }
      .main { padding: 20px 14px 60px; }
      .view-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    }
  </style>
</head>
<body>

  <div class="wrapper">
  <div class="sidebar">
    <div class="sidebar-logo"><a href="/">memory <span>book</span></a></div>

    {% set core = files | selectattr("type", "equalto", "core") | list %}
    {% set daily = files | selectattr("type", "equalto", "daily") | list %}

    {% if core %}
    <div class="sidebar-section">Core</div>
    {% for f in core %}
    <a class="sidebar-item {{ 'active' if f.name == filename }}" href="/view/{{ f.name }}">{{ f.display }}</a>
    {% endfor %}
    {% endif %}

    {% if daily %}
    <div class="sidebar-section">Daily</div>
    {% for f in daily %}
    <a class="sidebar-item {{ 'active' if f.name == filename }}" href="/view/{{ f.name }}">{{ f.display }}</a>
    {% endfor %}
    {% endif %}
  </div>

  <div class="main">
    <div class="mobile-back"><a href="/">← back to files</a></div>
    <div class="view-header">
      <h1>{{ display }}</h1>
      <div class="view-actions">
        <span class="save-status" id="save-status"></span>
        <button class="btn" id="toggle-edit" onclick="toggleEdit()">Edit</button>
      </div>
    </div>

    <!-- Read Mode -->
    <div id="read-mode">
      {% if sections | length > 3 %}
      <div class="toc">
        <div class="toc-title">Sections</div>
        {% for s in sections %}
        {% if s.title != "Preamble" %}
        <a href="#section-{{ loop.index }}">{{ s.title }}</a>
        {% endif %}
        {% endfor %}
      </div>
      {% endif %}

      <div class="sections">
        {% for s in sections %}
        <div class="section-card" id="section-{{ loop.index }}">
          {% if s.title != "Preamble" %}
          <h2>{{ s.title }}</h2>
          {% endif %}
          <div class="content">{{ s.content | render_markdown | safe }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Edit Mode -->
    <div class="editor-wrap" id="edit-mode">
      <textarea class="editor" id="editor" spellcheck="false">{{ content }}</textarea>
    </div>
  </div>
  </div>

  <script>
    let editMode = false;
    let saveTimeout;
    const filePath = "{{ files | selectattr('name', 'equalto', filename) | map(attribute='path') | first }}";

    function toggleEdit() {
      editMode = !editMode;
      document.getElementById('read-mode').style.display = editMode ? 'none' : 'block';
      document.getElementById('edit-mode').classList.toggle('active', editMode);
      document.getElementById('toggle-edit').classList.toggle('active', editMode);
      document.getElementById('toggle-edit').textContent = editMode ? 'Reading' : 'Edit';

      if (editMode) {
        document.getElementById('editor').focus();
      }
    }

    // Auto-save on edit
    document.getElementById('editor').addEventListener('input', () => {
      clearTimeout(saveTimeout);
      document.getElementById('save-status').textContent = 'Unsaved...';
      document.getElementById('save-status').classList.remove('saved');

      saveTimeout = setTimeout(async () => {
        const content = document.getElementById('editor').value;
        try {
          const res = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: filePath, content })
          });
          if (res.ok) {
            document.getElementById('save-status').textContent = '✓ Saved';
            document.getElementById('save-status').classList.add('saved');
            setTimeout(() => {
              document.getElementById('save-status').textContent = '';
            }, 3000);
          }
        } catch (e) {
          document.getElementById('save-status').textContent = 'Save failed';
        }
      }, 1000);
    });

    // Ctrl+E to toggle edit
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        toggleEdit();
      }
      // Ctrl+S to force save
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('editor').dispatchEvent(new Event('input'));
      }
    });
  </script>

</body>
</html>
