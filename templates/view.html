<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if display %}{{ display }} — {% endif %}Memory Book</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="apple-touch-icon" href="/static/favicon.svg">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=Fragment+Mono&display=swap');

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --white: #f0ece4;
      --white-dim: rgba(240, 236, 228, 0.45);
      --white-faint: rgba(240, 236, 228, 0.08);
      --white-ghost: rgba(240, 236, 228, 0.03);
      --black: #120D08;
      --accent: rgba(254, 111, 94, 0.8);
      --accent-dim: rgba(254, 111, 94, 0.15);
      --green: rgba(105, 219, 124, 0.7);
      --green-dim: rgba(105, 219, 124, 0.1);
      --scrollbar-thumb: rgba(254, 111, 94, 0.2);
      --scrollbar-hover: rgba(254, 111, 94, 0.4);
      --content-dim: rgba(240, 236, 228, 0.65);
      --content-strong: rgba(240, 236, 228, 0.85);
      --meta-dim: rgba(240, 236, 228, 0.18);
      --section-line: rgba(240, 236, 228, 0.06);
      --search-shadow: rgba(0,0,0,0.4);
      --sidebar-item-dim: rgba(240, 236, 228, 0.4);
      --sidebar-section-dim: rgba(240, 236, 228, 0.2);
      --toc-title-dim: rgba(240, 236, 228, 0.25);
      --landing-dim: rgba(240, 236, 228, 0.3);
      --search-placeholder: rgba(240, 236, 228, 0.2);
      --save-dim: rgba(240, 236, 228, 0.3);
      --btn-text: rgba(240, 236, 228, 0.5);
      --input-text: rgba(240, 236, 228, 0.7);
      --input-text-strong: rgba(240, 236, 228, 0.8);
    }

    [data-theme="light"] {
      --white: #2a1f14;
      --white-dim: rgba(42, 31, 20, 0.55);
      --white-faint: rgba(42, 31, 20, 0.1);
      --white-ghost: rgba(42, 31, 20, 0.04);
      --black: #f5f0e8;
      --accent: rgba(210, 72, 54, 0.9);
      --accent-dim: rgba(210, 72, 54, 0.1);
      --green: rgba(46, 160, 67, 0.8);
      --green-dim: rgba(46, 160, 67, 0.1);
      --scrollbar-thumb: rgba(210, 72, 54, 0.2);
      --scrollbar-hover: rgba(210, 72, 54, 0.4);
      --content-dim: rgba(42, 31, 20, 0.65);
      --content-strong: rgba(42, 31, 20, 0.85);
      --meta-dim: rgba(42, 31, 20, 0.25);
      --section-line: rgba(42, 31, 20, 0.08);
      --search-shadow: rgba(0,0,0,0.12);
      --sidebar-item-dim: rgba(42, 31, 20, 0.45);
      --sidebar-section-dim: rgba(42, 31, 20, 0.35);
      --toc-title-dim: rgba(42, 31, 20, 0.35);
      --landing-dim: rgba(42, 31, 20, 0.4);
      --search-placeholder: rgba(42, 31, 20, 0.3);
      --save-dim: rgba(42, 31, 20, 0.35);
      --btn-text: rgba(42, 31, 20, 0.5);
      --input-text: rgba(42, 31, 20, 0.7);
      --input-text-strong: rgba(42, 31, 20, 0.8);
    }

    html { background: var(--black); }

    body {
      height: 100vh;
      overflow: hidden;
      background: var(--black);
      font-family: 'DM Sans', sans-serif;
      color: var(--white);
    }

    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      min-width: 260px;
      height: 100vh;
      border-right: 1px solid var(--white-faint);
      padding: 24px 0;
      overflow-y: auto;
    }

    .sidebar::-webkit-scrollbar { width: 0; }
    .main::-webkit-scrollbar { width: 6px; }
    .main::-webkit-scrollbar-track { background: transparent; }
    .main::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
    .main::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

    .sidebar-logo {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 22px;
      font-weight: 400;
      padding: 0 20px 20px;
      letter-spacing: -0.02em;
      border-bottom: 1px solid var(--white-faint);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .sidebar-logo a {
      color: var(--white);
      text-decoration: none;
    }

    .sidebar-logo a span { color: var(--accent); }

    .theme-toggle {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--sidebar-item-dim);
      transition: color 0.2s;
      flex-shrink: 0;
    }
    .theme-toggle:hover { color: var(--accent); }
    .theme-toggle svg { width: 14px; height: 14px; }
    .theme-toggle .icon-sun { display: none; }
    [data-theme="light"] .theme-toggle .icon-moon { display: none; }
    [data-theme="light"] .theme-toggle .icon-sun { display: block; }

    .sidebar-item-meta {
      font-family: 'Fragment Mono', monospace;
      font-size: 10px;
      color: var(--meta-dim);
    }

    .sidebar-section {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--sidebar-section-dim);
      padding: 12px 20px 6px;
    }

    .sidebar-item {
      display: block;
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 300;
      color: var(--sidebar-item-dim);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }

    .sidebar-month {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }
    .sidebar-month:hover { color: var(--sidebar-item-dim); }
    .month-chevron { float: right; display: inline-flex; align-items: center; }
    .month-chevron svg { transition: transform 0.2s ease; }
    .sidebar-month.collapsed .month-chevron svg { transform: rotate(-90deg); }

    .sidebar-item:hover {
      color: var(--input-text-strong);
      background: var(--white-ghost);
    }

    .sidebar-item.active {
      color: var(--white);
      border-left-color: var(--accent);
      background: var(--accent-dim);
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 12px clamp(20px, 4vw, 60px) 80px;
      overflow-y: auto;
      height: 100vh;
    }

    /* Landing state (no file selected) */
    .landing {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .landing-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 18px;
      font-weight: 400;
      color: var(--landing-dim);
      margin-bottom: 24px;
      letter-spacing: -0.02em;
    }

    .search-container {
      width: 100%;
      max-width: 460px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px 14px 44px;
      border-radius: 12px;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: var(--input-text-strong);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 300;
      outline: none;
      transition: all 0.3s;
    }

    .search-input::placeholder {
      color: var(--search-placeholder);
    }

    .search-input:focus {
      border-color: rgba(254, 111, 94, 0.3);
      box-shadow: 0 0 0 3px rgba(254, 111, 94, 0.08);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--search-placeholder);
      font-size: 16px;
      pointer-events: none;
    }

    .search-results {
      margin-top: 16px;
      width: 100%;
      max-width: 460px;
    }

    .search-result {
      display: block;
      padding: 14px 18px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 10px;
      margin-bottom: 8px;
      text-decoration: none;
      transition: all 0.2s;
      animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .search-result:hover {
      border-color: rgba(254, 111, 94, 0.3);
      background: var(--accent-dim);
    }

    .search-result-file {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .search-result-line {
      font-size: 11px;
      color: var(--toc-title-dim);
      font-family: 'Bricolage Grotesque', sans-serif;
    }

    .search-result-match {
      font-size: 13px;
      font-weight: 300;
      color: var(--content-dim);
      line-height: 1.5;
      margin-top: 4px;
    }

    .search-result-match mark {
      background: var(--accent-dim);
      color: var(--white);
      border-radius: 2px;
      padding: 0 2px;
    }

    .search-empty {
      text-align: center;
      font-size: 13px;
      font-weight: 300;
      color: var(--search-placeholder);
      padding: 20px;
    }

    /* Inline search (when viewing a note) */
    .inline-search {
      position: relative;
      width: 200px;
    }

    .inline-search input {
      width: 100%;
      padding: 7px 14px 7px 32px;
      border-radius: 8px;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: var(--input-text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 300;
      outline: none;
      transition: all 0.2s;
    }

    .inline-search input:focus {
      border-color: rgba(254, 111, 94, 0.3);
    }

    .inline-search .search-icon {
      left: 10px;
      font-size: 13px;
    }

    .inline-search .inline-results {
      position: absolute;
      top: 100%;
      right: 0;
      width: 400px;
      max-height: 400px;
      overflow-y: auto;
      background: var(--black);
      border: 1px solid var(--white-faint);
      border-radius: 10px;
      margin-top: 8px;
      z-index: 100;
      display: none;
      box-shadow: 0 8px 32px var(--search-shadow);
    }

    .inline-search .inline-results.open { display: block; }

    .inline-search .inline-results .search-result {
      border-radius: 0;
      border: none;
      border-bottom: 1px solid var(--white-faint);
      margin: 0;
    }

    .inline-search .inline-results .search-result:last-child { border-bottom: none; }

    /* Header */
    .view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      animation: fadeDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .view-header h1 {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 400;
      font-size: clamp(28px, 4vw, 42px);
      letter-spacing: -0.03em;
    }

    .view-actions {
      display: flex; gap: 10px; align-items: center;
    }

    .view-actions .save-status {
      font-size: 12px;
      font-weight: 300;
      color: var(--save-dim);
      transition: all 0.3s;
    }

    .view-actions .save-status.saved { color: var(--green); }

    .btn {
      padding: 8px 18px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: var(--btn-text);
    }

    .btn:hover {
      color: var(--white);
      border-color: var(--white-faint);
      background: var(--white-ghost);
    }

    .btn.active {
      background: var(--accent-dim);
      border-color: rgba(254, 111, 94, 0.3);
      color: var(--accent);
    }

    /* TOC */
    .toc {
      margin-bottom: 30px;
      padding: 0;
      animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.1s;
    }

    .toc-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--toc-title-dim);
      margin-bottom: 10px;
    }

    .toc a {
      display: list-item;
      list-style: disc;
      margin-left: 18px;
      padding: 3px 0;
      font-size: 13px;
      font-weight: 300;
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .toc a:hover { opacity: 0.7; }

    /* Sections */
    .sections {
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.15s;
    }

    .section-card {
      padding: 20px 0;
      border-bottom: 1px solid var(--section-line);
    }

    .section-card:last-child { border-bottom: none; }

    .section-card.highlight {
      background: rgba(254, 111, 94, 0.06);
      border-left: 3px solid var(--accent);
      padding-left: 17px;
      border-radius: 4px;
      transition: background 2s ease, border-color 2s ease;
    }
    .section-card.highlight-fade {
      background: transparent;
      border-left-color: transparent;
    }

    .section-card h2 {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 22px;
      font-weight: 400;
      letter-spacing: -0.02em;
      margin-bottom: 14px;
      color: var(--white);
    }

    .section-card .content {
      font-size: 14px;
      font-weight: 300;
      color: var(--content-dim);
    }
    .section-card .content > *:last-child { margin-bottom: 0; padding-bottom: 0; }
    .section-card .content > br:last-child { display: none; }

    .section-card .content strong { color: var(--content-strong); font-weight: 500; }
    .section-card .content code {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 12px;
      background: var(--white-faint);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--accent);
    }
    .section-card .content ul, .section-card .content ol { padding-left: 20px; }
    .section-card .content li { margin-bottom: 4px; }
    .section-card .content a { color: var(--accent); text-decoration: none; }
    .section-card .content a:hover { text-decoration: underline; }

    /* Editor */
    .editor-wrap { display: none; animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .editor-wrap.active { display: block; }

    .editor {
      width: 100%;
      min-height: 70vh;
      padding: 24px 28px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 0;
      color: var(--input-text-strong);
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 13px;
      line-height: 1.75;
      resize: vertical;
      outline: none;
      transition: border-color 0.3s;
    }

    .editor:focus { border-color: rgba(254, 111, 94, 0.3); }

    .editor::-webkit-scrollbar { width: 8px; }
    .editor::-webkit-scrollbar-track { background: transparent; }
    .editor::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
    .editor::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }
    .editor::-webkit-scrollbar-corner { background: transparent; }

    /* Animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(28px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Jump to top */
    .jump-top {
      position: fixed;
      bottom: 32px;
      right: calc((100vw - 1200px) / 2 - 56px);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(254, 111, 94, 0.3);
      background: rgba(254, 111, 94, 0.08);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, background 0.2s;
    }
    .jump-top.visible { opacity: 1; pointer-events: auto; }
    .jump-top:hover { background: rgba(254, 111, 94, 0.2); }
    .jump-top svg { width: 16px; height: 16px; stroke: var(--accent); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .mobile-back { display: none; margin-bottom: 12px; }
    .mobile-back a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--white-faint);
      color: var(--accent);
      text-decoration: none;
      transition: background 0.2s;
    }
    .mobile-back a:hover { background: var(--white-ghost); }

    .mobile-search { display: none; padding: 12px 20px; }
    .mobile-search input {
      width: 100%;
      padding: 10px 14px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 8px;
      color: var(--white);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .mobile-search input:focus { border-color: rgba(254, 111, 94, 0.3); }
    .mobile-search input::placeholder { color: var(--toc-title-dim); }

    @media (max-width: 768px) {
      body { height: auto; overflow: auto; }
      .wrapper { flex-direction: column; height: auto; }
      .sidebar {
        width: 100%;
        min-width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--white-faint);
        {% if filename %}display: none;{% endif %}
      }
      .main {
        padding: 20px 14px 80px;
        height: auto;
        overflow: visible;
      }
      .mobile-back { display: block; }
      .mobile-search { display: block; }
      {% if not filename %}.main { display: none; }{% endif %}
      .view-header { flex-direction: column; align-items: flex-start; gap: 12px; }
      .inline-search input:focus { width: 200px; }
      .inline-search .inline-results { width: 300px; right: auto; left: 0; }
      .search-container { max-width: 100%; }
      .jump-top { right: 20px; }
    }
  </style>
</head>
<script>(function(){var t=localStorage.getItem('mb-theme');if(t)document.documentElement.setAttribute('data-theme',t);})();</script>
<body>

  <div class="wrapper">
  <div class="sidebar">
    <div class="sidebar-logo">
      <a href="/">Memory<span>Book</span></a>
      <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode" onclick="toggleTheme()">
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
    <div class="mobile-search">
      <input type="text" id="mobile-search-input" placeholder="Search memories..." autocomplete="off">
    </div>

    {% set core = files | selectattr("type", "equalto", "core") | list %}
    {% set daily = files | selectattr("type", "equalto", "daily") | list %}

    {% if core %}
    <div class="sidebar-section sidebar-month" data-month="core" onclick="this.classList.toggle('collapsed'); var c=this.classList.contains('collapsed'); var s=this.nextElementSibling; while(s && s.classList.contains('sidebar-item')){s.style.display=c?'none':''; s=s.nextElementSibling;} var st=JSON.parse(localStorage.getItem('mb-months')||'{}'); st[this.dataset.month]=c; localStorage.setItem('mb-months',JSON.stringify(st));">
      <span>Core</span>
      <span class="month-chevron"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></span>
    </div>
    {% for f in core %}
    <a class="sidebar-item {{ 'active' if filename and f.name == filename }}" href="/view/{{ f.name }}">{{ f.display }}<br><span class="sidebar-item-meta">{{ (f.size / 1024) | round(1) }}kb · {{ f.lines }} lines</span></a>
    {% endfor %}
    {% endif %}

    {% if daily %}
    {% set ns = namespace(current_month='') %}
    {% for f in daily %}
    {% if f.month_key != ns.current_month %}
    {% set ns.current_month = f.month_key %}
    {% set is_first_month = loop.first %}
    <div class="sidebar-section sidebar-month{% if not is_first_month %} collapsed{% endif %}" data-month="{{ f.month_key }}" onclick="this.classList.toggle('collapsed'); var c=this.classList.contains('collapsed'); var s=this.nextElementSibling; while(s && s.classList.contains('sidebar-item')){s.style.display=c?'none':''; s=s.nextElementSibling;} var st=JSON.parse(localStorage.getItem('mb-months')||'{}'); st[this.dataset.month]=c; localStorage.setItem('mb-months',JSON.stringify(st));">
      <span>{{ f.month_label }}</span>
      <span class="month-chevron"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></span>
    </div>
    {% endif %}
    <a class="sidebar-item {{ 'active' if filename and f.name == filename }}" href="/view/{{ f.name }}" {% if not loop.first and f.month_key != (daily[0].month_key if daily else '') %}style="display:none;"{% endif %}>{{ f.display }}<br><span class="sidebar-item-meta">{{ (f.size / 1024) | round(1) }}kb · {{ f.lines }} lines</span></a>
    {% endfor %}
    {% endif %}
  </div>

  <div class="main">
    {% if not sections %}
    <!-- Landing: no file selected -->
    <div class="landing">
      <div class="landing-title">Select a memory to read</div>
      <div class="search-container">
        <span class="search-icon">⌕</span>
        <input class="search-input" type="text" id="landing-search" placeholder="Search memories..." autocomplete="off" autofocus>
      </div>
      <div class="search-results" id="landing-results"></div>
    </div>

    {% else %}
    <!-- Viewing a file -->
    <div class="mobile-back"><a href="/"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></a></div>
    <div class="view-header">
      <h1>{{ display }}</h1>
      <div class="view-actions">
        <div class="inline-search">
          <span class="search-icon">⌕</span>
          <input type="text" id="inline-search" placeholder="Search..." autocomplete="off">
        </div>
        <span class="save-status" id="save-status"></span>
        <button class="btn" id="toggle-edit" onclick="toggleEdit()">Edit</button>
      </div>
    </div>

    <!-- Inline search results (replaces note content while searching) -->
    <div class="search-results" id="view-search-results" style="display:none;max-width:100%;"></div>

    <!-- Read Mode -->
    <div id="read-mode">
      {% if sections | length > 1 %}
      <div class="toc">
        <div class="toc-title">Sections</div>
        {% for s in sections %}
        {% if s.title != "Preamble" %}
        <a href="#section-{{ loop.index }}">{{ s.title }}</a>
        {% endif %}
        {% endfor %}
      </div>
      {% endif %}

      <div class="sections">
        {% for s in sections %}
        <div class="section-card" id="section-{{ loop.index }}" data-start-line="{{ s.line }}" data-end-line="{{ s.end_line }}">
          {% if s.title != "Preamble" %}
          <h2>{{ s.title }}</h2>
          {% endif %}
          <div class="content">{{ s.content | render_markdown | safe }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Edit Mode -->
    <div class="editor-wrap" id="edit-mode">
      <textarea class="editor" id="editor" spellcheck="false">{{ content }}</textarea>
    </div>
    {% endif %}
  </div>
  </div>

  <script>
    // === Theme toggle ===
    function toggleTheme() {
      var current = document.documentElement.getAttribute('data-theme');
      var next = current === 'light' ? 'dark' : 'light';
      if (next === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.removeItem('mb-theme');
      } else {
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('mb-theme', next);
      }
    }

    // === Scroll to line from hash ===
    (function() {
      var hash = window.location.hash;
      var m = hash && hash.match(/^#line-(\d+)/);
      if (!m) return;
      var targetLine = parseInt(m[1]);
      var sections = document.querySelectorAll('.section-card[data-start-line]');
      var target = null;
      sections.forEach(function(sec) {
        var start = parseInt(sec.dataset.startLine);
        var end = parseInt(sec.dataset.endLine);
        if (targetLine >= start && targetLine <= end) target = sec;
      });
      if (target) {
        setTimeout(function() {
          target.scrollIntoView({ block: 'center' });
          target.classList.add('highlight');
          setTimeout(function() { target.classList.add('highlight-fade'); }, 3000);
          setTimeout(function() { target.classList.remove('highlight', 'highlight-fade'); }, 5000);
        }, 200);
      }
    })();

    // === Sidebar month collapse ===
    (function() {
      var stored = JSON.parse(localStorage.getItem('mb-months') || '{}');
      document.querySelectorAll('.sidebar-month').forEach(function(header) {
        var key = header.dataset.month;
        var shouldCollapse;
        if (key in stored) {
          shouldCollapse = stored[key];
        } else {
          shouldCollapse = header.classList.contains('collapsed');
        }
        if (shouldCollapse) {
          header.classList.add('collapsed');
        } else {
          header.classList.remove('collapsed');
        }
        var item = header.nextElementSibling;
        while (item && item.classList.contains('sidebar-item')) {
          item.style.display = shouldCollapse ? 'none' : '';
          item = item.nextElementSibling;
        }
      });
    })();

    // === Search ===
    let searchTimeout;

    async function doSearch(query, resultsEl, isInline) {
      if (!query || query.length < 2) {
        resultsEl.innerHTML = '';
        if (isInline) resultsEl.classList.remove('open');
        return;
      }
      try {
        const r = await fetch('/api/search?q=' + encodeURIComponent(query));
        const data = await r.json();
        if (!data.results.length) {
          resultsEl.innerHTML = '<div class="search-empty">No results found</div>';
          if (isInline) resultsEl.classList.add('open');
          return;
        }
        var words = query.trim().split(/\s+/).filter(Boolean);
        var escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        var re = new RegExp('(' + escaped.join('|') + ')', 'gi');
        resultsEl.innerHTML = data.results.slice(0, 15).map((r, i) => {
          var match = r.match.replace(re, '<mark>$1</mark>');
          var sectionTag = r.section_title ? ' <span class="sidebar-item-meta">§ ' + r.section_title + '</span>' : '';
          return '<a class="search-result" href="/view/' + r.file + '#line-' + r.line + '" style="animation-delay:' + (i * 0.03) + 's">'
            + '<div class="search-result-file">' + r.file_display + ' <span class="search-result-line">line ' + r.line + '</span>' + sectionTag + '</div>'
            + '<div class="search-result-match">' + match + '</div>'
            + '</a>';
        }).join('');
        if (isInline) resultsEl.classList.add('open');
      } catch(e) {}
    }

    // Landing search
    const landingInput = document.getElementById('landing-search');
    const landingResults = document.getElementById('landing-results');
    if (landingInput) {
      landingInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = landingInput.value.trim();
        document.querySelector('.landing-title').style.display = q.length > 0 ? 'none' : '';
        searchTimeout = setTimeout(() => doSearch(q, landingResults, false), 250);
      });
    }

    // Inline search (when viewing a note)
    const inlineInput = document.getElementById('inline-search');
    const viewResults = document.getElementById('view-search-results');
    const readMode = document.getElementById('read-mode');
    if (inlineInput) {
      inlineInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = inlineInput.value.trim();
        if (q.length < 2) {
          viewResults.style.display = 'none';
          viewResults.innerHTML = '';
          if (readMode) readMode.style.display = '';
          return;
        }
        if (readMode) readMode.style.display = 'none';
        viewResults.style.display = '';
        searchTimeout = setTimeout(() => doSearch(q, viewResults, false), 250);
      });
    }

    // === Mobile search ===
    const mobileInput = document.getElementById('mobile-search-input');
    if (mobileInput) {
      mobileInput.addEventListener('input', () => {
        const q = mobileInput.value.trim().toLowerCase();
        document.querySelectorAll('.sidebar-item').forEach(item => {
          item.style.display = item.textContent.toLowerCase().includes(q) || q.length < 1 ? '' : 'none';
        });
      });
    }

    // === Editor ===
    let editMode = false;
    let saveTimeout2;
    const filePath = "{{ files | selectattr('name', 'equalto', filename) | map(attribute='path') | first if filename else '' }}";

    let _savePending = false;

    function toggleEdit() {
      editMode = !editMode;
      if (!editMode) {
        // Closing editor — save any pending changes then reload
        const doReload = () => window.location.reload();
        if (_savePending) {
          // Force immediate save, then reload
          clearTimeout(saveTimeout2);
          const content = document.getElementById('editor').value;
          fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: filePath, content })
          }).then(doReload).catch(doReload);
        } else {
          doReload();
        }
        return;
      }
      document.getElementById('read-mode').style.display = 'none';
      document.getElementById('edit-mode').classList.add('active');
      document.getElementById('toggle-edit').classList.add('active');
      document.getElementById('toggle-edit').textContent = 'Close';
      document.getElementById('editor').focus();
    }

    const editorEl = document.getElementById('editor');
    if (editorEl) {
      editorEl.addEventListener('input', () => {
        clearTimeout(saveTimeout2);
        document.getElementById('save-status').textContent = 'Unsaved...';
        document.getElementById('save-status').classList.remove('saved');
        _savePending = true;
        saveTimeout2 = setTimeout(async () => {
          const content = editorEl.value;
          try {
            const res = await fetch('/api/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: filePath, content })
            });
            if (res.ok) {
              _savePending = false;
              document.getElementById('save-status').textContent = '✓ Saved';
              document.getElementById('save-status').classList.add('saved');
              setTimeout(() => { document.getElementById('save-status').textContent = ''; }, 3000);
            }
          } catch (e) {
            document.getElementById('save-status').textContent = 'Save failed';
          }
        }, 1000);
      });
    }

    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'e') { e.preventDefault(); toggleEdit(); }
      if (e.ctrlKey && e.key === 's' && editorEl) { e.preventDefault(); editorEl.dispatchEvent(new Event('input')); }
      // / to focus search
      if (e.key === '/' && !editMode && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        const s = inlineInput || landingInput;
        if (s) s.focus();
      }
    });
  </script>

<div class="jump-top" id="jump-top" onclick="document.querySelector('.main').scrollTo({top:0,behavior:'smooth'})">
  <svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>
</div>
<script>
(function(){
  var m = document.querySelector('.main');
  if(m) m.addEventListener('scroll', function(){ document.getElementById('jump-top').classList.toggle('visible', m.scrollTop > 300); });
})();
</script>
</body>
</html>
