<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if display %}{{ display }} — {% endif %}Memory Book</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/static/PoetrySVG.svg">
  <link rel="apple-touch-icon" href="/static/PoetrySVG.svg">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=Fragment+Mono&display=swap');

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --white: #f0ece4;
      --white-dim: rgba(240, 236, 228, 0.45);
      --white-faint: rgba(240, 236, 228, 0.08);
      --white-ghost: rgba(240, 236, 228, 0.03);
      --black: #120D08;
      --accent: rgba(254, 111, 94, 0.8);
      --accent-dim: rgba(254, 111, 94, 0.15);
      --green: rgba(105, 219, 124, 0.7);
      --green-dim: rgba(105, 219, 124, 0.1);
    }

    html { background: var(--black); }

    body {
      height: 100vh;
      overflow: hidden;
      background: var(--black);
      font-family: 'DM Sans', sans-serif;
      color: var(--white);
    }

    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      min-width: 260px;
      height: 100vh;
      border-right: 1px solid var(--white-faint);
      padding: 24px 0;
      overflow-y: auto;
    }

    .sidebar::-webkit-scrollbar { width: 0; }
    .main::-webkit-scrollbar { width: 6px; }
    .main::-webkit-scrollbar-track { background: transparent; }
    .main::-webkit-scrollbar-thumb { background: rgba(254, 111, 94, 0.2); border-radius: 3px; }
    .main::-webkit-scrollbar-thumb:hover { background: rgba(254, 111, 94, 0.4); }

    .sidebar-logo {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 22px;
      font-weight: 400;
      padding: 0 20px 20px;
      text-align: center;
      letter-spacing: -0.02em;
      border-bottom: 1px solid var(--white-faint);
      margin-bottom: 16px;
    }

    .sidebar-logo a {
      color: var(--white);
      text-decoration: none;
    }

    .sidebar-logo a span { color: var(--accent); }

    .sidebar-section {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(240, 236, 228, 0.2);
      padding: 12px 20px 6px;
    }

    .sidebar-item {
      display: block;
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.4);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }

    .sidebar-item:hover {
      color: rgba(240, 236, 228, 0.8);
      background: var(--white-ghost);
    }

    .sidebar-item.active {
      color: var(--white);
      border-left-color: var(--accent);
      background: var(--accent-dim);
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 12px clamp(20px, 4vw, 60px) 80px;
      overflow-y: auto;
      height: 100vh;
    }

    /* Landing state (no file selected) */
    .landing {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .landing-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 18px;
      font-weight: 400;
      color: rgba(240, 236, 228, 0.3);
      margin-bottom: 24px;
      letter-spacing: -0.02em;
    }

    .search-container {
      width: 100%;
      max-width: 460px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px 14px 44px;
      border-radius: 12px;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: rgba(240, 236, 228, 0.8);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 300;
      outline: none;
      transition: all 0.3s;
    }

    .search-input::placeholder {
      color: rgba(240, 236, 228, 0.2);
    }

    .search-input:focus {
      border-color: rgba(254, 111, 94, 0.3);
      box-shadow: 0 0 0 3px rgba(254, 111, 94, 0.08);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(240, 236, 228, 0.2);
      font-size: 16px;
      pointer-events: none;
    }

    .search-results {
      margin-top: 16px;
      width: 100%;
      max-width: 460px;
    }

    .search-result {
      display: block;
      padding: 14px 18px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 10px;
      margin-bottom: 8px;
      text-decoration: none;
      transition: all 0.2s;
      animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .search-result:hover {
      border-color: rgba(254, 111, 94, 0.3);
      background: var(--accent-dim);
    }

    .search-result-file {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .search-result-line {
      font-size: 11px;
      color: rgba(240, 236, 228, 0.25);
      font-family: 'Bricolage Grotesque', sans-serif;
    }

    .search-result-match {
      font-size: 13px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.6);
      line-height: 1.5;
      margin-top: 4px;
    }

    .search-result-match mark {
      background: rgba(254, 111, 94, 0.25);
      color: var(--white);
      border-radius: 2px;
      padding: 0 2px;
    }

    .search-empty {
      text-align: center;
      font-size: 13px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.2);
      padding: 20px;
    }

    /* Inline search (when viewing a note) */
    .inline-search {
      position: relative;
      width: 200px;
    }

    .inline-search input {
      width: 100%;
      padding: 7px 14px 7px 32px;
      border-radius: 8px;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: rgba(240, 236, 228, 0.7);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 300;
      outline: none;
      transition: all 0.2s;
    }

    .inline-search input:focus {
      border-color: rgba(254, 111, 94, 0.3);
    }

    .inline-search .search-icon {
      left: 10px;
      font-size: 13px;
    }

    .inline-search .inline-results {
      position: absolute;
      top: 100%;
      right: 0;
      width: 400px;
      max-height: 400px;
      overflow-y: auto;
      background: #120D08;
      border: 1px solid var(--white-faint);
      border-radius: 10px;
      margin-top: 8px;
      z-index: 100;
      display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .inline-search .inline-results.open { display: block; }

    .inline-search .inline-results .search-result {
      border-radius: 0;
      border: none;
      border-bottom: 1px solid var(--white-faint);
      margin: 0;
    }

    .inline-search .inline-results .search-result:last-child { border-bottom: none; }

    /* Header */
    .view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      animation: fadeDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .view-header h1 {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 400;
      font-size: clamp(28px, 4vw, 42px);
      letter-spacing: -0.03em;
    }

    .view-actions {
      display: flex; gap: 10px; align-items: center;
    }

    .view-actions .save-status {
      font-size: 12px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.3);
      transition: all 0.3s;
    }

    .view-actions .save-status.saved { color: var(--green); }

    .btn {
      padding: 8px 18px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--white-faint);
      background: var(--white-ghost);
      color: rgba(240, 236, 228, 0.5);
    }

    .btn:hover {
      color: var(--white);
      border-color: rgba(240, 236, 228, 0.15);
      background: rgba(240, 236, 228, 0.06);
    }

    .btn.active {
      background: var(--accent-dim);
      border-color: rgba(254, 111, 94, 0.3);
      color: var(--accent);
    }

    /* TOC */
    .toc {
      margin-bottom: 30px;
      padding: 0;
      animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.1s;
    }

    .toc-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(240, 236, 228, 0.25);
      margin-bottom: 10px;
    }

    .toc a {
      display: list-item;
      list-style: disc;
      margin-left: 18px;
      padding: 3px 0;
      font-size: 13px;
      font-weight: 300;
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .toc a:hover { opacity: 0.7; }

    /* Sections */
    .sections {
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 0.15s;
    }

    .section-card {
      padding: 20px 0;
      border-bottom: 1px solid rgba(240, 236, 228, 0.06);
    }

    .section-card:last-child { border-bottom: none; }

    .section-card h2 {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 22px;
      font-weight: 400;
      letter-spacing: -0.02em;
      margin-bottom: 14px;
      color: var(--white);
    }

    .section-card .content {
      font-size: 14px;
      font-weight: 300;
      color: rgba(240, 236, 228, 0.65);
    }
    .section-card .content > *:last-child { margin-bottom: 0; padding-bottom: 0; }
    .section-card .content > br:last-child { display: none; }

    .section-card .content strong { color: rgba(240, 236, 228, 0.85); font-weight: 500; }
    .section-card .content code {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 12px;
      background: var(--white-faint);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--accent);
    }
    .section-card .content ul, .section-card .content ol { padding-left: 20px; }
    .section-card .content li { margin-bottom: 4px; }
    .section-card .content a { color: var(--accent); text-decoration: none; }
    .section-card .content a:hover { text-decoration: underline; }

    /* Editor */
    .editor-wrap { display: none; animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .editor-wrap.active { display: block; }

    .editor {
      width: 100%;
      min-height: 70vh;
      padding: 24px 28px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 0;
      color: rgba(240, 236, 228, 0.8);
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 13px;
      line-height: 1.75;
      resize: vertical;
      outline: none;
      transition: border-color 0.3s;
    }

    .editor:focus { border-color: rgba(254, 111, 94, 0.3); }

    .editor::-webkit-scrollbar { width: 8px; }
    .editor::-webkit-scrollbar-track { background: transparent; }
    .editor::-webkit-scrollbar-thumb { background: rgba(254, 111, 94, 0.3); border-radius: 4px; }
    .editor::-webkit-scrollbar-thumb:hover { background: rgba(254, 111, 94, 0.5); }
    .editor::-webkit-scrollbar-corner { background: transparent; }

    /* Animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(28px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Jump to top */
    .jump-top {
      position: fixed;
      bottom: 32px;
      right: calc((100vw - 1200px) / 2 - 56px);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(254, 111, 94, 0.3);
      background: rgba(254, 111, 94, 0.08);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, background 0.2s;
    }
    .jump-top.visible { opacity: 1; pointer-events: auto; }
    .jump-top:hover { background: rgba(254, 111, 94, 0.2); }
    .jump-top svg { width: 16px; height: 16px; stroke: var(--accent); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .mobile-back { display: none; margin-bottom: 12px; }
    .mobile-back a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--white-faint);
      color: var(--accent);
      text-decoration: none;
      transition: background 0.2s;
    }
    .mobile-back a:hover { background: var(--white-ghost); }

    .mobile-search { display: none; padding: 12px 20px; }
    .mobile-search input {
      width: 100%;
      padding: 10px 14px;
      background: var(--white-ghost);
      border: 1px solid var(--white-faint);
      border-radius: 8px;
      color: var(--white);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .mobile-search input:focus { border-color: rgba(254, 111, 94, 0.3); }
    .mobile-search input::placeholder { color: rgba(240, 236, 228, 0.25); }

    @media (max-width: 768px) {
      body { height: auto; overflow: auto; }
      .wrapper { flex-direction: column; height: auto; }
      .sidebar {
        width: 100%;
        min-width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--white-faint);
        {% if filename %}display: none;{% endif %}
      }
      .main {
        padding: 20px 14px 80px;
        height: auto;
        overflow: visible;
      }
      .mobile-back { display: block; }
      .mobile-search { display: block; }
      {% if not filename %}.main { display: none; }{% endif %}
      .view-header { flex-direction: column; align-items: flex-start; gap: 12px; }
      .inline-search input:focus { width: 200px; }
      .inline-search .inline-results { width: 300px; right: auto; left: 0; }
      .search-container { max-width: 100%; }
      .jump-top { right: 20px; }
    }
  </style>
</head>
<body>

  <div class="wrapper">
  <div class="sidebar">
    <div class="sidebar-logo"><a href="/">Memory<span>Book</span></a></div>
    <div class="mobile-search">
      <input type="text" id="mobile-search-input" placeholder="Search memories..." autocomplete="off">
    </div>

    {% set core = files | selectattr("type", "equalto", "core") | list %}
    {% set daily = files | selectattr("type", "equalto", "daily") | list %}

    {% if core %}
    <div class="sidebar-section">Core</div>
    {% for f in core %}
    <a class="sidebar-item {{ 'active' if filename and f.name == filename }}" href="/view/{{ f.name }}">{{ f.display }}<br><span style="font-family:'Fragment Mono',monospace;font-size:10px;color:rgba(240,236,228,0.18);">{{ (f.size / 1024) | round(1) }}kb · {{ f.lines }} lines</span></a>
    {% endfor %}
    {% endif %}

    {% if daily %}
    <div class="sidebar-section">Daily</div>
    {% for f in daily %}
    <a class="sidebar-item {{ 'active' if filename and f.name == filename }}" href="/view/{{ f.name }}">{{ f.display }}<br><span style="font-family:'Fragment Mono',monospace;font-size:10px;color:rgba(240,236,228,0.18);">{{ (f.size / 1024) | round(1) }}kb · {{ f.lines }} lines</span></a>
    {% endfor %}
    {% endif %}
  </div>

  <div class="main">
    {% if not sections %}
    <!-- Landing: no file selected -->
    <div class="landing">
      <div class="landing-title">Select a memory to read</div>
      <div class="search-container">
        <span class="search-icon">⌕</span>
        <input class="search-input" type="text" id="landing-search" placeholder="Search memories..." autocomplete="off" autofocus>
      </div>
      <div class="search-results" id="landing-results"></div>
    </div>

    {% else %}
    <!-- Viewing a file -->
    <div class="mobile-back"><a href="/"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></a></div>
    <div class="view-header">
      <h1>{{ display }}</h1>
      <div class="view-actions">
        <div class="inline-search">
          <span class="search-icon">⌕</span>
          <input type="text" id="inline-search" placeholder="Search..." autocomplete="off">
        </div>
        <span class="save-status" id="save-status"></span>
        <button class="btn" id="toggle-edit" onclick="toggleEdit()">Edit</button>
      </div>
    </div>

    <!-- Inline search results (replaces note content while searching) -->
    <div class="search-results" id="view-search-results" style="display:none;max-width:100%;"></div>

    <!-- Read Mode -->
    <div id="read-mode">
      {% if sections | length > 1 %}
      <div class="toc">
        <div class="toc-title">Sections</div>
        {% for s in sections %}
        {% if s.title != "Preamble" %}
        <a href="#section-{{ loop.index }}">{{ s.title }}</a>
        {% endif %}
        {% endfor %}
      </div>
      {% endif %}

      <div class="sections">
        {% for s in sections %}
        <div class="section-card" id="section-{{ loop.index }}">
          {% if s.title != "Preamble" %}
          <h2>{{ s.title }}</h2>
          {% endif %}
          <div class="content">{{ s.content | render_markdown | safe }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Edit Mode -->
    <div class="editor-wrap" id="edit-mode">
      <textarea class="editor" id="editor" spellcheck="false">{{ content }}</textarea>
    </div>
    {% endif %}
  </div>
  </div>

  <script>
    // === Search ===
    let searchTimeout;

    async function doSearch(query, resultsEl, isInline) {
      if (!query || query.length < 2) {
        resultsEl.innerHTML = '';
        if (isInline) resultsEl.classList.remove('open');
        return;
      }
      try {
        const r = await fetch('/api/search?q=' + encodeURIComponent(query));
        const data = await r.json();
        if (!data.results.length) {
          resultsEl.innerHTML = '<div class="search-empty">No results found</div>';
          if (isInline) resultsEl.classList.add('open');
          return;
        }
        const q = query.toLowerCase();
        resultsEl.innerHTML = data.results.slice(0, 15).map((r, i) => {
          const match = r.match.replace(new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<mark>$1</mark>');
          return '<a class="search-result" href="/view/' + r.file + '#line-' + r.line + '" style="animation-delay:' + (i * 0.03) + 's">'
            + '<div class="search-result-file">' + r.file_display + ' <span class="search-result-line">line ' + r.line + '</span></div>'
            + '<div class="search-result-match">' + match + '</div>'
            + '</a>';
        }).join('');
        if (isInline) resultsEl.classList.add('open');
      } catch(e) {}
    }

    // Landing search
    const landingInput = document.getElementById('landing-search');
    const landingResults = document.getElementById('landing-results');
    if (landingInput) {
      landingInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = landingInput.value.trim();
        document.querySelector('.landing-title').style.display = q.length > 0 ? 'none' : '';
        searchTimeout = setTimeout(() => doSearch(q, landingResults, false), 250);
      });
    }

    // Inline search (when viewing a note)
    const inlineInput = document.getElementById('inline-search');
    const viewResults = document.getElementById('view-search-results');
    const readMode = document.getElementById('read-mode');
    if (inlineInput) {
      inlineInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = inlineInput.value.trim();
        if (q.length < 2) {
          viewResults.style.display = 'none';
          viewResults.innerHTML = '';
          if (readMode) readMode.style.display = '';
          return;
        }
        if (readMode) readMode.style.display = 'none';
        viewResults.style.display = '';
        searchTimeout = setTimeout(() => doSearch(q, viewResults, false), 250);
      });
    }

    // === Mobile search ===
    const mobileInput = document.getElementById('mobile-search-input');
    if (mobileInput) {
      mobileInput.addEventListener('input', () => {
        const q = mobileInput.value.trim().toLowerCase();
        document.querySelectorAll('.sidebar-item').forEach(item => {
          item.style.display = item.textContent.toLowerCase().includes(q) || q.length < 1 ? '' : 'none';
        });
      });
    }

    // === Editor ===
    let editMode = false;
    let saveTimeout2;
    const filePath = "{{ files | selectattr('name', 'equalto', filename) | map(attribute='path') | first if filename else '' }}";

    let _savePending = false;

    function toggleEdit() {
      editMode = !editMode;
      if (!editMode) {
        // Closing editor — save any pending changes then reload
        const doReload = () => window.location.reload();
        if (_savePending) {
          // Force immediate save, then reload
          clearTimeout(saveTimeout2);
          const content = document.getElementById('editor').value;
          fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: filePath, content })
          }).then(doReload).catch(doReload);
        } else {
          doReload();
        }
        return;
      }
      document.getElementById('read-mode').style.display = 'none';
      document.getElementById('edit-mode').classList.add('active');
      document.getElementById('toggle-edit').classList.add('active');
      document.getElementById('toggle-edit').textContent = 'Close';
      document.getElementById('editor').focus();
    }

    const editorEl = document.getElementById('editor');
    if (editorEl) {
      editorEl.addEventListener('input', () => {
        clearTimeout(saveTimeout2);
        document.getElementById('save-status').textContent = 'Unsaved...';
        document.getElementById('save-status').classList.remove('saved');
        _savePending = true;
        saveTimeout2 = setTimeout(async () => {
          const content = editorEl.value;
          try {
            const res = await fetch('/api/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: filePath, content })
            });
            if (res.ok) {
              _savePending = false;
              document.getElementById('save-status').textContent = '✓ Saved';
              document.getElementById('save-status').classList.add('saved');
              setTimeout(() => { document.getElementById('save-status').textContent = ''; }, 3000);
            }
          } catch (e) {
            document.getElementById('save-status').textContent = 'Save failed';
          }
        }, 1000);
      });
    }

    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'e') { e.preventDefault(); toggleEdit(); }
      if (e.ctrlKey && e.key === 's' && editorEl) { e.preventDefault(); editorEl.dispatchEvent(new Event('input')); }
      // / to focus search
      if (e.key === '/' && !editMode && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        const s = inlineInput || landingInput;
        if (s) s.focus();
      }
    });
  </script>

<div class="jump-top" id="jump-top" onclick="document.querySelector('.main').scrollTo({top:0,behavior:'smooth'})">
  <svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>
</div>
<script>
(function(){
  var m = document.querySelector('.main');
  if(m) m.addEventListener('scroll', function(){ document.getElementById('jump-top').classList.toggle('visible', m.scrollTop > 300); });
})();
</script>
</body>
</html>
